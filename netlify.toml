[build]
  base = "."
  command = "cd client && npm ci && npm run build"
  publish = "client/dist"

[build.environment]
  NODE_VERSION = "20"
  DEBUG = "vite:*"
  SECRETS_SCAN_OMIT_PATHS = "env.example,dist/**/*,node_modules/**/*,client/node_modules/**/*,netlify/functions/**/*,.env*"
  SECRETS_SCAN_ENABLED = "false"
  CI = "false"

  # Supabase Configuration - Use Environment Variables from Netlify Dashboard
  # VITE_SUPABASE_URL = "set in Netlify Dashboard"
  # VITE_SUPABASE_ANON_KEY = "set in Netlify Dashboard"
  # VITE_ADMIN_EMAIL = "set in Netlify Dashboard"

  # Map Configuration (MapLibre doesn't need token)
  VITE_MAP_TILES_URL = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
  VITE_MAP_ATTRIBUTION = "© OpenStreetMap contributors"

  # API Configuration
  VITE_API_BASE_URL = "http://localhost:3001/api"

  # Subscription Configuration
  VITE_SUBSCRIPTION_ENABLED = "true"
  VITE_PREMIUM_FEATURES_ENABLED = "true"

# Cache optimization - using built-in Netlify cache

[dev]
  framework = "vite"
  command = "npm run dev:client"
  port = 8889
  targetPort = 5173
  autoLaunch = false
  # Set environment variable so Vite knows it's running through Netlify Dev
  # This allows HMR to use the correct port (8889) for WebSocket connections
  [dev.environment]
    NETLIFY_DEV = "true"
  # Exclude problematic folders from file watcher to prevent crashes
  # This prevents Netlify CLI from trying to watch folders it doesn't have permission to access
  # Limit watch to essential folders only to reduce load and prevent ECONNRESET errors
  # Netlify Dev file watcher can cause crashes on Windows with large projects
  watch = [
    "client/src/**",
    "client/public/**",
    "netlify/functions/**"
  ]
  # Note: supabase/migrations excluded to reduce watcher load
  # Migrations are run manually, not watched automatically
  # Netlify Dev should proxy unmatched routes to targetPort
  # If /src/* doesn't work through proxy, access Vite directly on port 5173

# API redirects - apply in both dev and production
# Order is CRITICAL - most specific routes first!
# These are specific enough to not interfere with Vite routes (/src/*, /@vite/*, /@id/*)

[[redirects]]
  from = "/api/og.png"
  to = "/.netlify/functions/og"
  status = 200
  force = true

[[redirects]]
  from = "/sitemap.xml"
  to = "/.netlify/functions/sitemap"
  status = 200
  force = true

[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200
  force = true

# Production-only redirects
# In development, Netlify Dev should proxy /src/*, /@vite/*, /@id/* to Vite automatically
[context.production]
  [[redirects]]
    from = "/*"
    to = "/index.html"
    status = 200

[functions]
  directory = "netlify/functions"
  # Mărește limita pentru funcții (în MB) - doar pentru cazuri mici, fișiere mari folosesc presigned URLs
  included_files = ["netlify/functions/**/*"]

# Supabase extension configured via Netlify App UI - no plugin configuration needed
# Trigger rebuild
